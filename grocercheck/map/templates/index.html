{% load static %}

<!DOCTYPE html>
<html>
	<head>
		<title>GrocerCheck: Your Local Supermarket Social Distancing Search Engine</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link href='https://fonts.googleapis.com/css?family=Nunito' rel='stylesheet'>
        <style>
/* Set the size of the div element that contains the map */
body{
    font-family: 'Nunito';
}

#map {
	height: 100%;
	width: 100%;
}
    html, body {
		height: 100%;
		margin: 0;
		padding: 0;
	}

	/* floating menu with live, historical, all stores buttons */
	#floating_menu{
		position: absolute;
		top: 20%;
		left: 1%;
		z-index: 50;
		height: auto;
		background-color: #fff;
		padding: 5px;
		border: 1px solid #999;
		width: 6em;
		border-radius: 10px;
	}
	/* container for store visibility buttons */
	#floating_menu label{
		display: block;
		margin: 0;
		margin-top: 6px;
		margin-bottom: 6px;
		position: relative;
		cursor: pointer;
		padding-left: 0;
		font-size: 18px;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		text-align: center;
		border-radius: 10px;
	}

	/* radio buttons, hidden */
	#floating_menu input{
		position: absolute;
		opacity: 0;
	}


	/* class for toggle */
	.switch {
		position: absolute;
		display: inline-block;
		width: 60px;
		height: 34px;
		top: 10;
		left: 10;
	}

	/* the checkbox for the toggle, hidden */
	.switch input {
		opacity: 0;
		width: 0px;
		height: 0px;
	}

	/* span for the custom toggle */
	.slider {
		position: absolute;
		cursor: pointer;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		background-color: #ccc;
		-webkit-transition: .4s;
		transition: .4s;

	}

	/* custom white dot inside toggle */
	.slider:before {
		position: absolute;
		content: "";
		height: 26px;
		width: 26px;
		left: 4px;
		bottom: 4px;
		background-color: white;
		-webkit-transition: .4s;
		transition: .4s;
	}

	/* change color of span when button checked */
	input:checked + .slider {
		background-color: #3AB64B;
	}

	input:focus + .slider {
		box-shadow: 0 0 1px #3AB64B;
	}

	input:checked + .slider:before {
		-webkit-transform: translateX(26px);
		-ms-transform: translateX(26px);
		transform: translateX(26px);
	}

	/* Rounded sliders */
	.slider.round {
		border-radius: 34px;
	}

	.slider.round:before {
		border-radius: 50%;
	}

	/* big container div for everything for the toggle */
	#toggle{
		position: absolute;
		top: 50%;
		left: 1%;
		background-color: #fff;
		z-index: 21;
		border: 1px solid #999;
		border-radius: 0 0 15px 15px;
	}

	/* div container for search bar */
	#searchbar {
		position:absolute;
		top:10px;
		left: 15%;
		width: calc(35% - 10px);
		height: 55px;
		z-index: 25;
		--searchheight: 55px;
	}

	/* form of search bar including text and button */
	form.search{
		height: 100%;
	}

	/* text input of search bar */
	form.search input[type=text] {
		padding: 10px;
		font-size: 17px;
		border: none;
        border-bottom-left-radius: 10px;
        border-top-left-radius: 10px;
		float: left;
		width: 80%;
		background: #f1f1f1;
		box-sizing: border-box;
		height: var(--searchheight);
	}

	/* image input of search bar (i.e. button) */
	form.search input[type=image]{
		position: absolute;
		left: 80%;
		width: var(--searchheight);
		height: var(--searchheight);
		padding: 10px;
		background: #3AB64B;
		color: white;
		font-size: 17px;
		border: none;
		border-left: none;
		cursor: pointer;
		box-sizing: border-box;
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
	}

	/* change color of search button when hovered */
	form.search input:hover[type=image]{
		background: #4BE360;
	}

	/* refer to comments in about.html for hamburger menu */
	#navtoggle
		{
		display: block;
		position: absolute;
		top: 10%;
		left: 1%;
		z-index: 500;
		bottom: 0;
		width: 0;
		-webkit-user-select: none;
		user-select: none;

	}

	#navtoggle a
		{
		text-decoration: none;
		color: #232323;

		transition: color 0.3s ease;
	}

	#navtoggle a:hover
		{
		color: forestgreen;
	}

	#navtoggle input
		{
		display: block;
		width: 40px;
		height: 32px;
		position: absolute;
		top: -7px;
		left: 3px;
		background: #fff;
		cursor: pointer;
        border: none;
        border-radius: 10px;
		opacity: 0; /* hide this */
		z-index: 1001; /* and place it over the hamburger */

		-webkit-touch-callout: none;
	}
	#navtoggle span
		{
		display: block;
		width: 33px;
		height: 4px;
		margin-bottom: 5px;
		position: relative;
		left: 10px;
		background: #3AB64B;
		border-radius: 3px;
		z-index: 1000;
        border: none;
		transform-origin: 4px 0px;

		transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0),
		background 0.5s cubic-bezier(0.77,0.2,0.05,1.0),
		opacity 0.55s ease;
	}

	#navtoggle span:first-child
		{
		transform-origin: 0% 0%;
	}

	#navtoggle span:nth-last-child(2)
	{
		transform-origin: 0% 100%;
	}
	#navtoggle input:checked ~ span
		{
		opacity: 1;
		transform: rotate(45deg) translate(-2px, -1px);
		background: #3AB64B;
	}
	#navtoggle input:checked ~ span:nth-last-child(3)
	{
		opacity: 0;
		transform: rotate(0deg) scale(0.2, 0.2);
	}
	#navtoggle input:checked ~ span:nth-last-child(2)
	{
		transform: rotate(-45deg) translate(0, -1px);
	}
	#navmenu
		{
		position: absolute;
		display: block;
		width: 300px;
		margin: -100px 0 0 -50px;
		padding: 50px;
		padding-top: 125px;
		height: auto;
		top: 0;
		bottom: 0;
		z-index: 500;
		background: #ededed;
        border: none;

		list-style-type: none;
		-webkit-font-smoothing: antialiased;
		/* to stop flickering of text in safari */

		transform-origin: 0% 0%;
		transform: translate(-100%, 0);

		transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0);
	}
	#navmenu ul{
		z-index: 500;

	}
	#spansquare{
		position: absolute;
		background: #fff;
		top: -6px;
		left: 5px;
		width: 40px;
		height: 34px;
		border: none;
		border-radius: 5px;

    }
	#navmenu li
		{
		padding: 10px 0;
		font-size: 22px;
	}
	#navtoggle input:checked ~ ul
		{

		transform: none;
	}


	/* container button for help button */
	#helpbuttondiv{
		position: absolute;
		top: 10px;
		left: 50%;
		width: 55px;
		height: 55px;
		z-index: 501;
		border: 1px solid #999;


	}

	/* help button itself */
	#helpbutton{
		background-color: #3AB64B;
		border: none;
		color: white;
		font-size: 40px;
		cursor: pointer;
		padding: 0;
		height: 100%;
		width: 100%;
		padding-left: 15px;
		padding-right: 15px;
	}

	/* div container for modal, appears on click of help button */
	.modal {
		display: none; /* Hidden by default */
		position: fixed; /* Stay in place */
		z-index: 100000; /* Sit on top */
		padding-top: 100px; /* Location of the box */
		left: 0;
		top: 0;
		width: 100%; /* Full width */
		height: 100%; /* Full height */
		overflow: auto; /* Enable scroll if needed */
		background-color: rgb(0,0,0); /* Fallback color */
		background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* div for modal content */
	.modal-content {
		background-color: #fefefe;
		margin: auto;
		padding: 20px;
		border: 1px solid #888;
		width: 80%;
	}

	/* The Close Button */
	.close {
		color: #aaaaaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
	}

	.close:hover,
	.close:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
	}

		</style>
		<link rel='icon' type='image.png' href="{% static 'images/GrocerCheckFavicon.png' %}" />

	</head>
	<body>


		<div id="helpbuttondiv">
			<button id="helpbutton"><i class="fa fa-question"></i></button>
		</div>

		<div id="modaldiv" class="modal">
			<div class="modal-content">
				<span class="close" id="close">&times;</span>
				<p>lorem ipsum</p>
			</div>
		</div>

		<script>
			//callback function for helpbutton clicked
			document.getElementById("helpbutton").onclick = function(){
				//display modal
				document.getElementById("modaldiv").style.display = "block";
			}

			//callback function for close button clicked
			document.getElementById("close").onclick = function(){
				//close modal
				document.getElementById("modaldiv").style.display = "none";
			}
			//callback function for click anywhere
			window.onclick = function(event){
				//if click target is modal (content and background)
				if(event.target == document.getElementById("modaldiv")){
					//close modal
					document.getElementById("modaldiv").style.display = "none";
				}
			}

		</script>

		<!-- hamburger menu -->
		<nav role="navigation">
			<div id="navtoggle">
				<input type="checkbox" id="hamburgerbutton"/>
				<div id='spansquare'>	</div>
				<span></span>
				<span></span>
				<span></span>


				<ul id="navmenu">
					<a href="{% url 'index' %}"><li>Home</li></a>
					<a href="{% url 'about' %}"><li>About Us</li></a>
					<a href="{% url 'blog' %}"><li>Blog</li></a>
					<a href="{% url 'sponsors' %}"><li>Sponsors</li></a>
					<a href="{% url 'contact' %}"><li>Contact Us</li></a>
					<a href="{% url 'media' %}"><li>Media</li></a>
				</ul>
			</div>
		</nav>



		<div id="searchbar">
			<form class="search" onsubmit='return false;'>
				<input id='searchtextfield' type="text" placeholder="Search GrocerCheck (Try name, address, location, or near me!)" name="searchfield"></input>
				<input type="image" onclick='searchClicked()'  src="{% static 'images/searchicon.png' %}"></input>
			</form>

		</div>



		<div id="floating_menu">

			<label class="container" id="livecontainer" for="livebutton">Live Data Only
				<input id="livebutton" type="radio" checked="checked" onclick="showLiveOnly()" name="radio">
			</label>

			<label class="container" id="histcontainer" for="histbutton">
				Live and Past Data
				<input id="histbutton" type="radio" onclick="showHistorical()" name="radio">
			</label>

			<label class="container" id="allcontainer" for="allbutton">
				Show All Stores
				<input id="allbutton" type="radio" onclick="showAll()"  name="radio">
			</label>
		</div>

		<div id="toggle">
			<label class="switch">
				<input onclick="toggleStores()" type=checkbox>
				<span class="slider round"></span>
				<p style="color:forestgreen; margin-top:0;border-radius: 0 0 10px 10px; margin-bottom: 0; border: 1px solid #999;padding-top: 20px; text-align:center; background-color:#fff;"><b>Show Closed Stores</b></p>

			</label>
		</div>




		<!--The div element for the map -->
		<div id="map"></div>
		
        <script src="https://cdn.jsdelivr.net/npm/fuzzball@1.3.0/dist/fuzzball.umd.min.js"></script>
		<script>
//define global variables outside of initMap()
			var livemarkers = [] //all live markers
var historicalmarkers = [] //all markers with historical only
var allstores = [] //the remaining stores with no data at all
var markers = [] //all markers 
var map;
var openn; 
var flag = true;
var state = "live";
var keywords;
var earchedStores = [];
var searchInProgress = false;
var names = [];
var address = [];
function initMap() {

//create map
	map = new google.maps.Map(
		document.getElementById('map'), {zoom: 12, center: {lat:49.2399,lng:-123.1251}});

	// if geolocation is available
	if(navigator.geolocation){
		
		//get current position
		navigator.geolocation.getCurrentPosition(function(position) {
			var userpos = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
			};

			map.setCenter(userpos);


		}, function(){ //handle error if location invalid
			handleLocationError(true,map.getCenter());
		}
		);

	}
	else{ //handle error
		handleLocationError(false,map.getCenter());
	}





//importing from context from views.py
	names = {{name|safe}}


	var place_id = {{place_id|safe}}

	address = {{address|safe}}
	var lat = {{lat|safe}}
	var lng = {{lng|safe}}
	var place_id = {{place_id|safe}}
	var hours = {{hours|safe}}
	var busyness = {{busyness|safe}}
	openn = {{openn|safe}}
	keywords = {{keywords|safe}}
	var positions = [] //list of all positions as {lat, lng}
	for(let x = 0;x<lat.length;x++){
		positions.push({lat:parseFloat(lat[x]), lng:parseFloat(lng[x])})
	}



	function buildInfoWindowString(names,address,hours,busyness,x){
		var s = '';//text color
		var pops = '';//popularity string
		var busy = busyness[x];
		var statusstring = '';
		var t = "true";;
		if(openn[x]==1){
			statusstring = 'Open';
		}
		else{
			statusstring = 'Closed';
		}
		if(busy==-1){
			pops = "No Popularity Data Available";
		}
		else if(busy>=1000){
			busy-=1000;
			pops = "Currently "+busy+"% Busy";
		}else{
			pops = "Historically is "+busy+"% Busy Right Now"
		}
		if(busy>60){
			s = 'red';
		}
		else if(busy>30){
			s = 'goldenrod';
		}
		else if(busy>=0){
			s = 'limegreen';
		}
		else{
			s = 'grey';
		}

		if(openn[x]==0){
			pops='';
			s='grey';
		}
//return formatted html of infowindow
		return '<div id="content">' +
			'<h1 style="color:'+s+';"> '+names[x]+' </h1>' +
			'<div id="body"'+
			'<p> '+address[x]+' </p>'+
			'<p> '+hours[x]+' </p>'+
			'<p> '+statusstring+' </p>'+
			'<p> '+pops+' </p> '+
			'</div>'+
			'</div>';
	}

	//loading static images of markers
	var green = "{% static 'images/greenmarker.png' %}"
	var yellow = "{% static 'images/yellowmarker.png' %}"
	var red = "{% static 'images/redmarker.png' %}"
	var grey = "{% static 'images/greymarker.png' %}"



	var icon = null;


//build marker
	function buildMarker(color,radius,position){
		if(color=="grey"){//if grey, use static image instead of vector for efficiency
			return new google.maps.Marker({icon:{url:grey, scaledSize:new google.maps.Size(radius*2, radius*2)}, clickable:true, position:position, map:map});
		}
		//build vector path of circle with radius=radius 
		let pathstring = "M-"+radius+",0a"+radius+","+radius+" 0 1,0 "+(radius*2)+",0a"+radius+","+radius+" 0 1,0 -"+(radius*2)+",0";
		return new google.maps.Marker({icon:{path:pathstring,fillColor:color, fillOpacity:0.6, strokeWeight:0},clickable:true,position:position,map:map});

	}

	function openInfoWindow(i){
		//if infowindow already open, close it
		if(infowindow){
			infowindow.close();
		}

		//open infowindow on new marker with new html content
		infowindow.setContent(buildInfoWindowString(names,address,hours,busyness,i));
		infowindow.open(map,temp);


	}

//returns gradient color of marker given x index
	function getIcon(x){
		if(openn[x]==0){
			return "grey";
		}
		let b = busyness[x];
		if(busyness[x]>=1000){
			b-=1000;
		}
		if(b>=0){
			if(b>100){
				return "rgb(255,0,255)";
			}
			else if(b>=70){
				return "rgb(255, 0, 0)";
			}
			else if(b>=35){
				return "rgb(255, "+Math.round((70-b)*(255/35))+", 0)";
			}
			else{
				return "rgb("+Math.round((b)*(255/35))+", 255, 0)";
			}
		}
		else{
			return "grey";
		}
	}

	var infowindow = new google.maps.InfoWindow();
	for(let x = 0; x<positions.length;x++){

		if(busyness[x]==-1){
			//No data available
			var temp = buildMarker(getIcon(x),10,positions[x])
			markers.push(temp)
			allstores.push(temp);

		}
		else if(busyness[x]>=1000){
			//live data available
			var busy = busyness[x]-1000;

			var temp = buildMarker(getIcon(x),15,positions[x]);
			markers.push(temp);
			livemarkers.push(temp);
		}

		else{
			//only historical data available
			var temp = buildMarker(getIcon(x),10,positions[x])
			markers.push(temp)
			historicalmarkers.push(temp)
		}



	}
	for(let k = 0; k<markers.length;k++){
		markers[k].addListener('click',function() {
			infowindow.setContent(buildInfoWindowString(names,address,hours,busyness,k));
			infowindow.open(map,markers[k]);
		});

	}



	showLiveOnly();//default view on site visit is live only
	toggleStores();//toggle on and off, starts as show closed = true, toggle to set it to false immediately so it displays properly
}

//callback function on search button click
function searchClicked(){
	searchedStores = [];
	//grab user input and encode to prevent injection
	var searchstring = encodeURI(document.getElementById('searchtextfield').value).toLowerCase();

	//if search not empty
	if(searchstring!=""){
		searchInProgress = true;

	}
	else{
		//clear search, display all markers with the right state
		searchInProgress = false;
		searchedStores = [];
		displaySearched();
		filterByState();
		return;
	}

	//replace encoded space " " with actual space
	searchstring = searchstring.replace(/%20/g, " ");


	var max = 0;
	var arr = [];
	let r;
	let comparestring;
	if(searchstring.includes("street") || searchstring.includes("avenue") || searchstring.includes("boulevard") || searchstring.includes(" highway") || searchstring.includes("+")  || searchstring.includes("-") || searchstring.includes(" ") || searchstring.includes(" and ")){
		//account for misspellings
		let variations = getVariations(searchstring);
		for(let p = 0; p<variations.length;p++){
			searchstring += " "+variations[p];
		}
	}

	if(searchstring.includes("tnt")){
		searchstring = "t&t "+searchstring;
	}

	for(let x = 0; x<markers.length;x++){
		comparestring = names[x]+" "+address[x]+" "+keywords[x];
		//	r = Math.max(fuzzball.token_set_ratio(searchstring, comparestring), fuzzball.ratio(searchstring, comparestring));
		r = fuzzball.token_set_ratio(searchstring, comparestring)
		arr.push(r);
		if(r>max){
			max = r;
		}
	}

	for(let x = 0; x<markers.length;x++){

		if(arr[x] > max*0.75){
			searchedStores.push(markers[x]);

		}

	}
	if(state=='live'){ showLiveOnly();}
	if(state=='historical'){ showHistorical();}
	if(state=='all') { showAll();}
	displaySearched();
}

function getVariations(word){
	let arr = [];

	if(word.includes("+")){
		arr.push(word.replace(/\+/g, " and "));
	}
	if(word.includes("-")){
		arr.push(word.replace(/-/g, " "));
	}
	if(word.includes(" ")){
		arr.push(word.replace(/ /g, "-"));
		arr.push(word.replace(/ /g, ""));
	}
	if(word.includes(" and ")){
		arr.push(word.replace(/ and /g, "&"));
	}
	if(word.includes("street")){
		arr.push(word.replace(/street/g, "st"));
	}
	if(word.includes("avenue")){
		arr.push(word.replace(/avenue/g, "ave"));
	}
	if(word.includes("boulevard")){
		arr.push(word.replace(/boulevard/g, "blvd"));
	}
	if(word.includes("highway")){
		arr.push(word.replace(/highway/g, "hwy"));
	}
	return arr;
}


function displaySearched(){
	for(let x = 0; x<markers.length;x++){
		if(markers[x].getVisible()){
			if(searchedStores.includes(markers[x])==false){
				markers[x].setMap(null);
			}
		}
	}
}

function filterByState(){
	if(state=='live'){
		showLiveOnly();
	}
	if(state=='historical'){
		showHistorical();
	}
	if(state=='all'){
		showAll();
	}
}

function handleLocationError(hasgeo, pos){
	if(hasgeo){
		map.setCenter(pos);
	}
	else{
		map.setCenter(pos);
	}
}

function filterOpen(){
	for(let x = 0; x<markers.length;x++){
		if(openn[x]==0){
			markers[x].setMap(null);
		}
	}
}

function checkState(){
	if(flag==false){
		filterOpen();
	}
	if(flag==true && state=="live"){
		filterOpen();
	}
	if(searchInProgress){
		displaySearched();
	}
}

function showLiveOnly(){
	document.getElementById("livecontainer").style.background = "#3AB64B";
	document.getElementById("histcontainer").style.background = "transparent";
	document.getElementById("allcontainer").style.background = "transparent";
	for(let x = 0; x<livemarkers.length;x++){
		livemarkers[x].setMap(map);
	}
	for(let x = 0; x<historicalmarkers.length;x++){
		historicalmarkers[x].setMap(null);
	}
	for(let x = 0; x<allstores.length;x++){
		allstores[x].setMap(null);
	}
	state = "live";
	checkState();

}



function showHistorical(){
	document.getElementById("livecontainer").style.background = "transparent";
	document.getElementById("histcontainer").style.background = "#3AB64B";
	document.getElementById("allcontainer").style.background = "transparent";


	for(let x = 0; x<livemarkers.length;x++){
		livemarkers[x].setMap(map);
	}
	for(let x = 0; x<historicalmarkers.length;x++){


		historicalmarkers[x].setMap(map);
	}
	for(let x = 0; x<allstores.length;x++){
		allstores[x].setMap(null);
	}
	state = "historical";
	checkState();


}

function showAll(){
	document.getElementById("livecontainer").style.background = "transparent";
	document.getElementById("histcontainer").style.background = "transparent";
	document.getElementById("allcontainer").style.background = "#3AB64B";

	for(let x = 0; x<livemarkers.length;x++){
		livemarkers[x].setMap(map);
	}
	for(let x = 0; x<historicalmarkers.length;x++){
		historicalmarkers[x].setMap(map);
	}
	for(let x = 0; x<allstores.length;x++){
		allstores[x].setMap(map);
	}
	state = "all";
	checkState();

}

function toggleStores(){

	if(flag){
		//hide closed stores

		for(let x = 0; x<markers.length;x++){
			if(openn[x]==0){
				markers[x].setMap(null);
			}
		}
		flag = false;
	}
	else{
		//show closed stores

		for(let x = 0; x<markers.length;x++){

			if(openn[x]==0){
				markers[x].setMap(map);
			}
		}
		flag = true
		if(state=="live"){
			showLiveOnly();
		}
		if(state=="historical"){
			showHistorical();
		}
		if(state=="all"){
			showAll();
		}

	}

}



		</script>
		<!--Load the API from the specified URL
	  * The async attribute allows the browser to render the page while the API loads
	  * The key parameter will contain your own API key (which is not needed for this tutorial)
	  * The callback parameter executes the initMap() function
		-->
		<script async defer

			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqwU_hVg2OJ3zB7FOORGzGIdsWnXdXT-w&callback=initMap">
		</script>
	</body>
</html>
