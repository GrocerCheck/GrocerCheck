{% load static %}

<!DOCTYPE html>
<html>
	<head>
		<style>
/* Set the size of the div element that contains the map */
#map {
	height: 100%;  /* The height is 400 pixels */
	width: 100%;  /* The width is the width of the web page */
}
      html, body {
	      height: 100%;
	      margin: 0;
	      padding: 0;
      }
      #floating_menu{
	      position: absolute;
	      top: 20%;
	      left: 1%;
	      z-index: 50;
	      height: auto;
	      background-color: #fff;
	      padding: 5px;
	      border: 1px solid #999;
	      width: 6em;
	      border-radius: 15px;
      }

      #floating_menu label{
	      display: block;
	      margin: 0;
	     margin-top: 6px;
	     margin-bottom: 6px;
	      position: relative;
	      cursor: pointer;
	      padding-left: 0;
	      font-size: 18px;
	      -webkit-user-select: none;
	      -moz-user-select: none;
	      -ms-user-select: none;
	      user-select: none;
	      text-align: center;
		border-radius: 10px;
      }
      #floating_menu input{
	      position: absolute;
	      opacity: 0;
      }



      .switch {
	      position: absolute;
	      display: inline-block;
	      width: 60px;
	      height: 34px;
	      top: 10;
	      left: 10;
      }

      .switch input {
	      opacity: 0;
	      width: 0px;
	      height: 0px;
      }

      .slider {
	      position: absolute;
	      cursor: pointer;
	      top: 0;
	      left: 0;
	      bottom: 0;
	      right: 0;
	      background-color: #ccc;
	      -webkit-transition: .4s;
	      transition: .4s;

      }
      .slider:before {
	      position: absolute;
	      content: "";
	      height: 26px;
	      width: 26px;
	      left: 4px;
	      bottom: 4px;
	      background-color: white;
	      -webkit-transition: .4s;
	      transition: .4s;
      }

      input:checked + .slider {
	      background-color: #3AB64B;
      }

      input:focus + .slider {
	      box-shadow: 0 0 1px #3AB64B;
      }

      input:checked + .slider:before {
	      -webkit-transform: translateX(26px);
	      -ms-transform: translateX(26px);
	      transform: translateX(26px);
      }

      /* Rounded sliders */
      .slider.round {
	      border-radius: 34px;
      }

      .slider.round:before {
	      border-radius: 50%;
      }
      #toggle{
	      position: absolute;
	      top: 50%;
	      left: 1%;
	      background-color: #fff;
	      z-index: 21;
	      border: 1px solid #999;
	      border-radius: 0 0 15px 15px;
      }

      #searchbar {
	      position:absolute;
	      top:10px;
	      left: 15%;
	      width: calc(35% - 10px);
	      height: 55px;
	      z-index: 25;
	      --searchheight: 55px;
      }
      form.search{
	      height: 100%;
      }
      form.search input[type=text] {
	      padding: 10px;
	      font-size: 17px;
	      border: 1px solid #999;
	      float: left;
	      width: 80%;
	      background: #f1f1f1;
	      box-sizing: border-box;
	      height: var(--searchheight);
      }

      form.search input[type=image]{
	      position: absolute;
	      left: 80%;
	      width: var(--searchheight);
	      height: var(--searchheight);
	      padding: 10px;
	      background: #3AB64B;
	      color: white;
	      font-size: 17px;
	      border: 1px solid #999;
	      border-left: none;
	      cursor: pointer;
	      box-sizing: border-box;
      }

      form.search input:hover[type=image]{
	      background: #4BE360;
      }


      #navtoggle
	      {
	      display: block;
	      position: absolute;
	      top: 10%;
	      left: 1%;
	      z-index: 500;
	      bottom: 0;
	      width: 0;
	      -webkit-user-select: none;
	      user-select: none;

      }

      #navtoggle a
	      {
	      text-decoration: none;
	      color: #232323;

	      transition: color 0.3s ease;
      }

      #navtoggle a:hover
	      {
	      color: forestgreen;
      }

      #navtoggle input
	      {
	      display: block;
	      width: 40px;
	      height: 32px;
	      position: absolute;
	      top: -7px;
	      left: 3px;
	      background: #fff;
	      cursor: pointer;
	      border-radius: 15px;
	      opacity: 0; /* hide this */
	      z-index: 1001; /* and place it over the hamburger */

	      -webkit-touch-callout: none;
      }
      #navtoggle span
	      {
	      display: block;
	      width: 33px;
	      height: 4px;
	      margin-bottom: 5px;
	      position: relative;
	      left: 10px;
	      background: #3AB64B;
	      border-radius: 3px;

	      z-index: 1000;

	      transform-origin: 4px 0px;

	      transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0),
	      background 0.5s cubic-bezier(0.77,0.2,0.05,1.0),
	      opacity 0.55s ease;
      }

      #navtoggle span:first-child
	      {
	      transform-origin: 0% 0%;
      }

      #navtoggle span:nth-last-child(2)
      {
	      transform-origin: 0% 100%;
      }
      #navtoggle input:checked ~ span
	      {
	      opacity: 1;
	      transform: rotate(45deg) translate(-2px, -1px);
	      background: #3AB64B;
      }
      #navtoggle input:checked ~ span:nth-last-child(3)
      {
	      opacity: 0;
	      transform: rotate(0deg) scale(0.2, 0.2);
      }
      #navtoggle input:checked ~ span:nth-last-child(2)
      {
	      transform: rotate(-45deg) translate(0, -1px);
      }
      #navmenu
	      {
	      position: absolute;
	      display: block;
	      width: 300px;
	      margin: -100px 0 0 -50px;
	      padding: 50px;
	      padding-top: 125px;
	      height: auto;
	      top: 0;
	      bottom: 0;
	      z-index: 500;
	      background: #ededed;

	      list-style-type: none;
	      -webkit-font-smoothing: antialiased;
	      /* to stop flickering of text in safari */

	      transform-origin: 0% 0%;
	      transform: translate(-100%, 0);

	      transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0);
      }
      #navmenu ul{
	      z-index: 500;

      }
      #spansquare{
	      position: absolute;
	      background: #fff;
	      top: -6px;
	      left: 5px;
	      width: 40px;
	      height: 34px;
	      border: 1px solid #999;
	      border-radius: 5px;
      }
      #navmenu li
	      {
	      padding: 10px 0;
	      font-size: 22px;
      }
      #navtoggle input:checked ~ ul
	      {

	      transform: none;
      }

		</style>

		<link rel='icon' type='image.png' href="{% static 'images/GrocerCheckFavicon.png' %}" />

	</head>
	<body>


		<nav role="navigation">
			<div id="navtoggle">
				<input type="checkbox" id="hamburgerbutton"/>
				<div id='spansquare'>	</div>
				<span></span>
				<span></span>
				<span></span>


				<ul id="navmenu">
					<a href="{% url 'index' %}"><li>Home</li></a>
					<a href="{% url 'about' %}"><li>About Us</li></a>
				</ul>
			</div>
		</nav>



		<div id="searchbar">
			<form class="search" onsubmit='return false;'>
				<input id='searchtextfield' type="text" placeholder="Search GrocerCheck (Try name, address, location, or near me!)" name="searchfield"></input>
				<input type="image" onclick='searchClicked()'  src="{% static 'images/searchicon.png' %}"></input>
			</form>

		</div>



		<div id="floating_menu">

			<label class="container" id="livecontainer" for="livebutton">Show Live Data Only
				<input id="livebutton" type="radio" checked="checked" onclick="showLiveOnly()" name="radio">
			</label>

			<label class="container" id="histcontainer" for="histbutton">
				Live and Historical Data
				<input id="histbutton" type="radio" onclick="showHistorical()" name="radio">
			</label>

			<label class="container" id="allcontainer" for="allbutton">
				Show All Stores
				<input id="allbutton" type="radio" onclick="showAll()"  name="radio">
			</label>
		</div>

		<div id="toggle">
			<label class="switch">
				<input onclick="toggleStores()" type=checkbox>
				<span class="slider round"></span>
				<p style="color:forestgreen; margin-top:0;border-radius: 0 0 10px 10px; margin-bottom: 0; border: 1px solid #999;padding-top: 20px; text-align:center; background-color:#fff;"><b>Show Closed Stores</b></p>

			</label>
		</div>



		<!--The div element for the map -->
		<div id="map"></div>
		<script src="https://cdn.jsdelivr.net/npm/fuzzball@1.3.0/dist/fuzzball.umd.min.js"></script>
		<script>

			var livemarkers = []
var historicalmarkers = []
var allstores = []
var markers = []
var map;
var openn;
var flag = true;
var state = "live";
var keywords;
var searchedStores = [];
var searchInProgress = false;
var names = [];
var address = [];
function initMap() {


	map = new google.maps.Map(
		document.getElementById('map'), {zoom: 12, center: {lat:49.2399,lng:-123.1251}});

	if(navigator.geolocation){

		navigator.geolocation.getCurrentPosition(function(position) {
			var userpos = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
			};

			map.setCenter(userpos);


		}, function(){
			handleLocationError(true,map.getCenter());
		}
		);

	}
	else{
		handleLocationError(false,map.getCenter());
	}






	names = {{name|safe}}


	var place_id = {{place_id|safe}}

	address = {{address|safe}}
	var lat = {{lat|safe}}
	var lng = {{lng|safe}}
	var place_id = {{place_id|safe}}
	var hours = {{hours|safe}}
	var busyness = {{busyness|safe}}
	openn = {{openn|safe}}
	keywords = {{keywords|safe}}
	var positions = []
	for(let x = 0;x<lat.length;x++){
		positions.push({lat:parseFloat(lat[x]), lng:parseFloat(lng[x])})
	}



	function buildInfoWindowString(names,address,hours,busyness,x){
		var s = '';
		var pops = '';
		var busy = busyness[x];
		var statusstring = '';
		var t = "true";;
		if(openn[x]==1){
			statusstring = 'Open';
		}
		else{
			statusstring = 'Closed';
		}
		if(busy==-1){
			pops = "No Popularity Data Available";
		}
		else if(busy>=1000){
			busy-=1000;
			pops = "Currently "+busy+"% Busy";
		}else{
			pops = "Historically is "+busy+"% Busy Right Now"
		}
		if(busy>60){
			s = 'red';
		}
		else if(busy>30){
			s = 'goldenrod';
		}
		else if(busy>=0){
			s = 'limegreen';
		}
		else{
			s = 'grey';
		}

		if(openn[x]==0){
			pops='';
			s='grey';
		}

		return '<div id="content">' +
			'<h1 style="color:'+s+';"> '+names[x]+' </h1>' +
			'<div id="body"'+
			'<p> '+address[x]+' </p>'+
			'<p> '+hours[x]+' </p>'+
			'<p> '+statusstring+' </p>'+
			'<p> '+pops+' </p> '+
			'</div>'+
			'</div>';
	}

	var green = "{% static 'images/greenmarker.png' %}"
	var yellow = "{% static 'images/yellowmarker.png' %}"
	var red = "{% static 'images/redmarker.png' %}"
	var grey = "{% static 'images/greymarker.png' %}"



	var icon = null;



	function buildMarker(icona,width,height,position){

		return new google.maps.Marker({icon:{url:icona, scaledSize:new google.maps.Size(width,height)},clickable:true,position:position,map:map});

	}

	function openInfoWindow(i){
		if(infowindow){
			infowindow.close();
		}
		infowindow.setContent(buildInfoWindowString(names,address,hours,busyness,i));
		infowindow.open(map,temp);


	}


	function getIcon(x){
		if(openn[x]==0){
			return grey;
		}
		let b = busyness[x];
		if(busyness[x]>=1000){
			b-=1000;
		}
		if(b>60){
			return red;
		}
		else if(b>30){
			return yellow;
		}
		else if(b>=0){
			return green;
		}
		else{
			return grey;
		}
	}

	var infowindow = new google.maps.InfoWindow();
	for(let x = 0; x<positions.length;x++){

		if(busyness[x]==-1){
			//No data available
			var temp = buildMarker(grey,20,20,positions[x])
			markers.push(temp)
			allstores.push(temp);

		}
		else if(busyness[x]>=1000){
			//live data available
			var busy = busyness[x]-1000;
			icon = getIcon(x);
			var temp = buildMarker(icon,30,30,positions[x]);
			markers.push(temp);
			livemarkers.push(temp);
		}

		else{
			//only historical data available
			icon = getIcon(x);
			var temp = buildMarker(icon,20,20,positions[x])
			markers.push(temp)
			historicalmarkers.push(temp)
		}



	}
	for(let k = 0; k<markers.length;k++){
		markers[k].addListener('click',function() {
			infowindow.setContent(buildInfoWindowString(names,address,hours,busyness,k));
			infowindow.open(map,markers[k]);
		});

	}
	showLiveOnly();
	toggleStores();
}
function searchClicked(){
	searchedStores = [];

	var searchstring = encodeURI(document.getElementById('searchtextfield').value).toLowerCase();

	if(searchstring!=""){
		searchInProgress = true;

	}
	else{

		searchInProgress = false;
		searchedStores = [];
		return;
	}
	searchstring = searchstring.replace(/%20/g, " ");


	var max = 0;
	var arr = [];
	let r;
	let comparestring;
	if(searchstring.includes("street") || searchstring.includes("avenue") || searchstring.includes("boulevard") || searchstring.includes(" highway") || searchstring.includes("+")  || searchstring.includes("-") || searchstring.includes(" ") || searchstring.includes(" and ")){
		//account for misspellings
		let variations = getVariations(searchstring);
		for(let p = 0; p<variations.length;p++){
			searchstring += " "+variations[p];
		}
	}

	if(searchstring.includes("tnt")){
		searchstring = "t&t "+searchstring;
	}

	for(let x = 0; x<markers.length;x++){
		comparestring = names[x]+" "+address[x]+" "+keywords[x];
		//	r = Math.max(fuzzball.token_set_ratio(searchstring, comparestring), fuzzball.ratio(searchstring, comparestring));
		r = fuzzball.token_set_ratio(searchstring, comparestring)
		arr.push(r);
		if(r>max){
			max = r;
		}
	}

	for(let x = 0; x<markers.length;x++){

		if(arr[x] > max*0.75){
			searchedStores.push(markers[x]);

		}

	}
	if(state=='live'){ showLiveOnly();}
	if(state=='historical'){ showHistorical();}
	if(state=='all') { showAll();}
	displaySearched();
}

function getVariations(word){
	let arr = [];

	if(word.includes("+")){
		arr.push(word.replace(/\+/g, " and "));
	}
	if(word.includes("-")){
		arr.push(word.replace(/-/g, " "));
	}
	if(word.includes(" ")){
		arr.push(word.replace(/ /g, "-"));
		arr.push(word.replace(/ /g, ""));
	}
	if(word.includes(" and ")){
		arr.push(word.replace(/ and /g, "&"));
	}
	if(word.includes("street")){
		arr.push(word.replace(/street/g, "st"));
	}
	if(word.includes("avenue")){
		arr.push(word.replace(/avenue/g, "ave"));
	}
	if(word.includes("boulevard")){
		arr.push(word.replace(/boulevard/g, "blvd"));
	}
	if(word.includes("highway")){
		arr.push(word.replace(/highway/g, "hwy"));
	}
	return arr;
}


function displaySearched(){
	for(let x = 0; x<markers.length;x++){
		if(markers[x].getVisible()){
			if(searchedStores.includes(markers[x])==false){
				markers[x].setMap(null);
			}
		}
	}
}


function handleLocationError(hasgeo, pos){
	if(hasgeo){
		map.setCenter(pos);
	}
	else{
		map.setCenter(pos);
	}
}

function filterOpen(){
	for(let x = 0; x<markers.length;x++){
		if(openn[x]==0){
			markers[x].setMap(null);
		}
	}
}

function checkState(){
	if(flag==false){
		filterOpen();
	}
	if(flag==true && state=="live"){
		filterOpen();
	}
	if(searchInProgress){
		displaySearched();
	}
}

function showLiveOnly(){
	document.getElementById("livecontainer").style.background = "#3AB64B";
	document.getElementById("histcontainer").style.background = "transparent";
	document.getElementById("allcontainer").style.background = "transparent";
	for(let x = 0; x<livemarkers.length;x++){
		livemarkers[x].setMap(map);
	}
	for(let x = 0; x<historicalmarkers.length;x++){
		historicalmarkers[x].setMap(null);
	}
	for(let x = 0; x<allstores.length;x++){
		allstores[x].setMap(null);
	}
	state = "live";
	checkState();

}



function showHistorical(){
	document.getElementById("livecontainer").style.background = "transparent";
	document.getElementById("histcontainer").style.background = "#3AB64B";
	document.getElementById("allcontainer").style.background = "transparent";


	for(let x = 0; x<livemarkers.length;x++){
		livemarkers[x].setMap(map);
	}
	for(let x = 0; x<historicalmarkers.length;x++){


		historicalmarkers[x].setMap(map);
	}
	for(let x = 0; x<allstores.length;x++){
		allstores[x].setMap(null);
	}
	state = "historical";
	checkState();


}

function showAll(){
	document.getElementById("livecontainer").style.background = "transparent";
	document.getElementById("histcontainer").style.background = "transparent";
	document.getElementById("allcontainer").style.background = "#3AB64B";

	for(let x = 0; x<livemarkers.length;x++){
		livemarkers[x].setMap(map);
	}
	for(let x = 0; x<historicalmarkers.length;x++){
		historicalmarkers[x].setMap(map);
	}
	for(let x = 0; x<allstores.length;x++){
		allstores[x].setMap(map);
	}
	state = "all";
	checkState();

}

function toggleStores(){

	if(flag){
		//hide closed stores

		for(let x = 0; x<markers.length;x++){
			if(openn[x]==0){
				markers[x].setMap(null);
			}
		}
		flag = false;
	}
	else{
		//show closed stores

		for(let x = 0; x<markers.length;x++){

			if(openn[x]==0){
				markers[x].setMap(map);
			}
		}
		flag = true
		if(state=="live"){
			showLiveOnly();
		}
		if(state=="historical"){
			showHistorical();
		}
		if(state=="all"){
			showAll();
		}

	}

}



		</script>
		<!--Load the API from the specified URL
	  * The async attribute allows the browser to render the page while the API loads
	  * The key parameter will contain your own API key (which is not needed for this tutorial)
	  * The callback parameter executes the initMap() function
		-->
		<script async defer

			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqwU_hVg2OJ3zB7FOORGzGIdsWnXdXT-w&callback=initMap">
		</script>
	</body>
</html>
